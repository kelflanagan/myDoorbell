########################################################################
# Author: J. Kelly Flanagan
# Copyright (c) 2015
#
# myDoorbellPlay.py plays the doorbell ringtone and raises an event when 
# the doorbell is asserted. 
#
# myDoorbellPlay.py attempts to do the following:
#
# 1. waits for the front or rear doorbell to be asserted
# 2. when a button is asserted the configuration file is read to determine
#    the volume to set the mixer to and the ringtone to play.
# 3. start a process to play ringtone
# 4. start a process to raise event
# 5. wait for both processes to complete
########################################################################

#!/usr/local/bin/python

import subprocess
import ast
import json

myDoorbellHomeDir = '/home'
myDoorbellConfig = {}

# begin here
# wait fir asserted front or rear bell
# this code get written later

# read configuration file
# read in the configuration file if it exists and store in a dictionary
def get_config():
    global myDoorbellConfig

    try:
        f = open(myDoorbellHomeDir + '/myDoorbell/myDoorbellConfig', 'r')
    except IOError: 
        print "Can't open config file %s" % (myDoorbellHomeDir + '/myDoorbell/myDoorbellConfig')
        return False
    else:
        my_string = f.read()
        myDoorbellConfig = ast.literal_eval(my_string)
        f.close()
    return True
# end function

# set volume
def set_volume(bell):
    global myDoorbellConfig

    mixer_str = "/usr/local/bin/amixer -q -c 0 set PCM "
    if bell == 'front':
        if myDoorbellConfig['silent_front'] == 'true':
            mixer_str = mixer_str + "0%"
        else:
            mixer_str = mixer_str + str(myDoorbellConfig['volume_front']) + "%"
    elif bell == 'rear':
        if myDoorbellConfig['silent_rear'] == 'true':
            mixer_str = mixer_str + "0%"
        else:
            mixer_str = mixer_str + str(myDoorbellConfig['volume_rear']) + "%"
    else:
        return False
    
    print mixer_str
    subprocess.call(mixer_str, shell=True)
    
    return True
# end function

if get_config() == False:
    print 'get config failed'

if set_volume('front') == False:
    print 'set volume failed'
